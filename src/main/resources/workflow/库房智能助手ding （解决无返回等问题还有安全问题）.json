{
  "name": "åº“æˆ¿æ™ºèƒ½åŠ©æ‰‹ding",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ding_talk",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2144,
        -688
      ],
      "id": "13e30fd0-b408-4061-9ec3-dced1dad448c",
      "name": "Webhook",
      "webhookId": "6b068a9d-0228-4b74-8b59-09a05e05cb99"
    },
    {
      "parameters": {
        "jsCode": "// ä»Webhookæ¥æ”¶çš„é’‰é’‰æ¶ˆæ¯ä¸­æå–contentï¼ˆç”¨æˆ·è¾“å…¥çš„æŒ‡ä»¤ï¼‰\n// const dingtalkMsg = $input.body; // Webhookæ¥æ”¶çš„æ¶ˆæ¯ä½“\nconst userInput = $input.first().json.body.content // é’‰é’‰æ¶ˆæ¯ä¸­çš„å†…å®¹ï¼ˆå¦‚#æŸ¥è¯¢è®¢å• 123ï¼‰\n// ç”Ÿæˆä¼šè¯IDï¼šç”¨ç”¨æˆ·IDï¼ˆç¡®ä¿å”¯ä¸€ï¼ŒåŒºåˆ†ä¸åŒç”¨æˆ·çš„ä¸Šä¸‹æ–‡ï¼‰\nconst sessionId = $input.first().json.body.userId; \n\n// è¾“å‡ºuserInputï¼Œä¼ é€’ç»™åç»­èŠ‚ç‚¹ï¼ˆæ›¿ä»£åŸæ¥Chat Triggerçš„è¾“å…¥ï¼‰\nreturn {\n  userInput: userInput,\n  // å¯é€‰ï¼šä¼ é€’å…¶ä»–å­—æ®µï¼ˆå¦‚userName/groupNameï¼‰\n  userName: $input.first().json.body.userName,\n  groupName: $input.first().json.body.groupName,\n  sessionId: sessionId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        -688
      ],
      "id": "69f61314-8fe5-48f5-bbb7-5a71e8179e9f",
      "name": "get msg from dingtalk"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.session }}",
        "contextWindowLength": 10
      },
      "id": "8c284826-1322-406c-be40-8cf113e2ff1f",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        -864,
        -464
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "232c4e0a-56d9-45bb-b9e2-d655ae424b89",
              "name": "",
              "value": "{{ $('query table column').item.json.table_name}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "d7898da0-c29a-4a8d-96ec-b5ef60d3539a",
      "name": "Add table name to output",
      "type": "n8n-nodes-base.set",
      "position": [
        -1232,
        -1024
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "./assemblylinetest.json",
        "options": {}
      },
      "id": "c11cd8b0-2910-412b-8bfa-988ca6a9130f",
      "name": "Save file locally",
      "type": "n8n-nodes-base.readWriteFile",
      "position": [
        -784,
        -1024
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "id": "0d1dd916-8ab1-45bf-b057-9a23df84dcce",
      "name": "Extract data from file",
      "type": "n8n-nodes-base.extractFromFile",
      "position": [
        -1456,
        -688
      ],
      "typeVersion": 1
    },
    {
      "parameters": {},
      "id": "346de4c4-751c-4954-b71d-8ae01878a939",
      "name": "When clicking \"Test workflow\"",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -1904,
        -1024
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f78c57d9-df13-43c7-89a7-5387e528107e",
              "name": "chatinput",
              "type": "string",
              "value": "={{ $('get msg from dingtalk').item.json.userInput }}"
            },
            {
              "id": "e42b39eb-dfbd-48d9-94ed-d658bdd41454",
              "name": "schema",
              "type": "string",
              "value": "={{ $json.data }}"
            },
            {
              "id": "a29c18d1-742d-440c-83fd-ffa025b6e1f5",
              "name": "session",
              "value": "={{ $('get msg from dingtalk').item.json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "b6fc5909-8e96-4049-9ad1-06bffbe3eabf",
      "name": "Combine schema data and chat input",
      "type": "n8n-nodes-base.set",
      "position": [
        -1232,
        -688
      ],
      "executeOnce": true,
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "fileSelector": "./assemblylinetest.json",
        "options": {}
      },
      "id": "64592a81-8bac-4aae-aa94-0c2e4fc714b9",
      "name": "Load the schema from the local file",
      "type": "n8n-nodes-base.readWriteFile",
      "position": [
        -1680,
        -688
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "toJson",
        "options": {}
      },
      "id": "5013beef-78f0-4867-88e0-67dff529f512",
      "name": "Convert data to Json",
      "type": "n8n-nodes-base.convertToFile",
      "position": [
        -1008,
        -1024
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  column_name, \n  data_type, \n  is_nullable, \n  column_default\nFROM information_schema.columns\nWHERE table_name  = '{{ $json.table_name }}'\n  AND table_schema = 'assemblylinetest'\nORDER BY ordinal_position;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -1456,
        -1024
      ],
      "id": "2ceedbd9-5226-4a7d-b1af-a8103589877e",
      "name": "query table column",
      "credentials": {
        "mySql": {
          "id": "jeuyRGGNFRmxYNor",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n\ttable_name\nFROM\n\tinformation_schema. TABLES\nWHERE\n\tTABLE_schema = 'assemblylinetest'\nAND table_name IN (\n\t'final_storeroom_conf',\n\t'final_storeroom_store',\n\t'product_material',\n\t'stock_expired_time',\n\t'stock_log',\n\t'store',\n\t'storeroom'\n)",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -1680,
        -1024
      ],
      "id": "6f829314-7d16-4089-b6db-d30b5a08f4d2",
      "name": "query tables name",
      "credentials": {
        "mySql": {
          "id": "jeuyRGGNFRmxYNor",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        -1056,
        -464
      ],
      "id": "3c2b3fae-6137-475d-b157-3b232546ac2d",
      "name": "DeepSeek Chat Model",
      "credentials": {
        "deepSeekApi": {
          "id": "bbxetBHK56SfIClw",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Here is the database schema: {{ $json.schema }}\nè¿™æ˜¯ç”¨æˆ·çš„æé—®\n{{ $json.chatinput }}\n\næ•°æ®åº“åˆ«åå‘½åè§„èŒƒï¼š\n  - ä½¿ç”¨è¡¨åçš„ç¼©å†™æˆ–é¦–å­—æ¯ä½œä¸ºåˆ«å\n  - é¿å…ä½¿ç”¨SQLä¿ç•™å­—ï¼ˆå¦‚SET, KEY, INDEX, ORDER, GROUPç­‰ï¼‰\n  - æ¨èä½¿ç”¨ï¼šst, sl, pm, sr, se_timeç­‰\n  - è¡¨åç¼©å†™è§„åˆ™ï¼š\n    * product_material â†’ pm\n    * store â†’ s\n    * storeroom â†’ sr  \n    * stock_log â†’ sl\n    * stock_expired_time â†’ se_time æˆ– setime\n\nè¯·æ ¹æ®éœ€æ±‚ç”ŸæˆMySQL SQLè¯­å¥ï¼Œè¦æ±‚ï¼š\n1. å­—æ®µåˆ«åå°½é‡ç”¨ä¸­æ–‡,ç±»ä¼¼typeç­‰å­—æ®µè¿”å›å¤‡æ³¨é‡Œçš„ä¸­æ–‡ï¼ˆç¦æ­¢ä½¿ç”¨/ã€ç©ºæ ¼ç­‰ç‰¹æ®Šç¬¦å·ï¼‰ï¼›\n2. åªè¿”å›çº¯SQLè¯­å¥ï¼Œä¸è¦åŒ…å«è¯´æ˜æ–‡å­—ï¼›\n3. SQLè¯­å¥ä»¥;ç»“å°¾ã€‚\n4. ç¦æ­¢æ‰§è¡Œæˆ–è€…ç”Ÿæˆinsert,update,deleteç­‰æ“ä½œï¼Œåªèƒ½ç”Ÿæˆselectç­‰sqlè¯­å¥ï¼Œä¿æŠ¤æ•°æ®åº“æ•°æ®\n",
        "options": {
          "systemMessage": "\nä¸€ã€è§’è‰²å®šä½\nè§’è‰²ï¼šMySQL DBA ä¸“å®¶\nç®€ä»‹ï¼šä¸€ä½æŠ€è‰ºé«˜è¶…ã€ç»éªŒä¸°å¯Œçš„ MySQL æ•°æ®åº“ç®¡ç†å‘˜ï¼Œä¸“é—¨æ ¹æ®ç”¨æˆ·éœ€æ±‚å’Œæä¾›çš„æ•°æ®ç»“æ„ï¼Œç²¾å¿ƒåˆ¶ä½œç²¾ç¡®é«˜æ•ˆçš„ SQL æŸ¥è¯¢ã€‚\nèƒŒæ™¯ï¼šåœ¨å„ç§ä¸šåŠ¡æ‹¥æœ‰ä¸°å¯Œçš„æ•°æ®è®¾è®¡ã€ä¼˜åŒ–å’Œ MySQL æ•°æ®åº“æŸ¥è¯¢å¼€å‘ç»éªŒã€‚\næ“…é•¿ï¼šåˆ†æéœ€æ±‚ã€ä¸»é¢˜æ¨¡å‹ã€è¯¢é—®ç­›é€‰ã€ç›´æ¥ç†è§£è§£å†³æ–¹ç´¢ï¼Œæ— éœ€ä¸å¿…è¦çš„è§£é‡Šã€‚\nç›®æ ‡å—ä¼—ï¼šéœ€è¦æ ¹æ®æ•°æ®ç»“æ„å’Œæ‰€éœ€ä¿¡æ¯ç”Ÿæˆç‰¹å®š SQL æŸ¥è¯¢çš„ç”¨æˆ·ã€‚\n\näºŒã€æ ¸å¿ƒèƒ½åŠ›\nSQL æŸ¥è¯¢ç”Ÿæˆ\næŸ¥è¯¢åˆæˆï¼šæ„å»ºè¯­æ³•æ­£ç¡®ã€è¯­ä¹‰å‡†ç¡®çš„ SQL æŸ¥è¯¢ã€‚\næ•°æ®ç»“æ„è§£è¯»ï¼šç†è§£å¹¶åˆ©ç”¨æä¾›çš„æ•°æ®åº“ç»“æ„è¿›è¡ŒæŸ¥è¯¢ç”Ÿæˆã€‚\næŸ¥è¯¢ä¼˜åŒ–ï¼šç¼–å†™é«˜æ•ˆæŸ¥è¯¢ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚\nèšåˆä¸åˆ†ç»„ï¼šä½¿ç”¨èšåˆå‡½æ•°å’Œåˆ†ç»„æ¥æ±‡æ€»æ•°æ®ã€‚\n\nMySQL æ•°æ®åº“çŸ¥è¯†\nSchema è®¾è®¡ï¼šç†è§£å¹¶åˆ©ç”¨æ•°æ®åº“ Schema è¿›è¡Œæœ‰æ•ˆæŸ¥è¯¢ã€‚\næ•°æ®ç±»å‹ï¼šè¯†åˆ«å’Œå¤„ç† MySQL ä¸­ä¸åŒæ•°æ®ç±»å‹ã€‚\nç´¢å¼•ï¼šç†è§£ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“ã€‚\nå¸¸ç”¨ SQL å‡½æ•°ï¼šåˆ©ç”¨å†…ç½® SQL å‡½æ•°è¿›è¡Œæ•°æ®æ“ä½œå’Œåˆ†æã€‚\n\né—®é¢˜è§£å†³\néœ€æ±‚åˆ†æï¼šç†è§£ç”¨æˆ·çš„æŸ¥è¯¢éœ€æ±‚ã€‚\né€»è¾‘æ¨ç†ï¼šè¿ç”¨é€»è¾‘æ¨ç†æ¨å¯¼å‡ºæ­£ç¡®çš„ SQL æŸ¥è¯¢ã€‚\næ•°æ®åˆ†æå¸ˆï¼šåˆ©ç”¨æ•°æ®åˆ†ææŠ€æœ¯è¿›è¡Œæœ‰æ•ˆçš„æŸ¥è¯¢è®¾è®¡ã€‚\næ¨¡å¼è¯†åˆ«ï¼šè¯†åˆ«å¸¸è§æŸ¥è¯¢æ¨¡å¼å¹¶å°†å…¶é€‚é…åˆ°ç‰¹å®šåœºæ™¯ã€‚\næ²Ÿé€š\nç®€æ´æ²Ÿé€šï¼šæä¾›ç›´æ¥ä¸”å¯æ‰§è¡Œçš„ SQL ä»£ç ã€‚\néœ€æ±‚æ¾„æ¸…ï¼šåœ¨éœ€è¦æ—¶æå‡ºæ¾„æ¸…é—®é¢˜ä»¥ç”Ÿæˆç›¸å…³æŸ¥è¯¢ã€‚\nç¤ºä¾‹å’Œè§£é‡Šï¼šä»ç”¨æˆ·çš„ç¤ºä¾‹ä¸­å­¦ä¹ ä»¥æ”¹å–„æŸ¥è¯¢ç”Ÿæˆã€‚\n\nä¸‰ã€å·¥ä½œè§„èŒƒä¸æµç¨‹\nç§‰æ‰¿ SQL æ ‡å‡†ï¼šç¡®ä¿ SQL è¯­å¥ç¬¦åˆ MySQL å…¼å®¹çš„æ ‡å‡† SQL è¯­æ³•ã€‚\næ€§èƒ½è€ƒè™‘ï¼šå§‹ç»ˆè€ƒè™‘æŸ¥è¯¢æ€§èƒ½å¹¶åœ¨é€‚å½“æ—¶åº”ç”¨ä¼˜åŒ–ã€‚\n\nè¿­ä»£ä¼˜åŒ–ï¼šå¦‚æœç¬¬ä¸€ä¸ªæŸ¥è¯¢ä¸ç†æƒ³ï¼Œæ ¹æ®åç»­ç”¨æˆ·è¾“å…¥è¿›è¡Œä¼˜åŒ–ã€‚\nçº¦æŸ\nä¸åšå‡è®¾ï¼šä¸è¦å¯¹æ•°æ® Schema åšå‡ºè¶…å‡ºæä¾›çš„å‡è®¾ã€‚\næœ‰é™äº¤äº’ï¼šå°½é‡å‡å°‘ç”¨æˆ·çš„è¯·æ±‚ï¼Œå°½å¯èƒ½æ¨æ–­æ„å›¾ã€‚\nä¸ä½¿ç”¨å¤–éƒ¨èµ„æºï¼šä¸è¦ä½¿ç”¨å¤–éƒ¨èµ„æºæˆ–å·¥å…·æ¥ç”ŸæˆæŸ¥è¯¢ã€‚\næ•°æ®ç²¾ç®€ï¼šç¡®ä¿è¿”å›ä¸å¤šä¸å°‘è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä¸å«ä¸å¿…è¦åœ°æš´éœ²æ•æ„Ÿä¿¡æ¯ã€‚\n\nå·¥ä½œæµç¨‹\nç›®æ ‡ï¼šæ ¹æ®ç»™å®šæ•°æ®ç»“æ„ï¼Œç”Ÿæˆå‡†ç¡®é«˜æ•ˆåœ°å›ç­”ç”¨æˆ·é—®é¢˜çš„ MySQL æŸ¥è¯¢ã€‚\næ­¥éª¤ 1ï¼šåˆ†æç”¨æˆ·çš„è¯·æ±‚ï¼Œç¡®å®šæ‰€éœ€ç»“æœå’Œæ•°æ®éœ€æ±‚ã€‚\næ­¥éª¤ 2ï¼šæ£€æŸ¥æä¾›çš„æ•°æ®ç»“æ„ï¼Œè¯†åˆ«ç›¸å…³çš„è¡¨ã€åˆ—å’Œå…³ç³»ã€‚\næ­¥éª¤ 3ï¼šæ„å»ºä¸€ä¸ª SQL æŸ¥è¯¢ï¼Œæ ¹æ®éœ€è¦é€‰æ‹©ã€è¿‡æ»¤ã€èšåˆå’Œæ’åºæ•°æ®ã€‚\næ­¥éª¤ 4ï¼šç¡®ä¿ç”Ÿæˆçš„æŸ¥è¯¢éµå¾ª SQL æ ‡å‡†å’Œ MySQL è¯­æ³•ï¼Œå¹¶é’ˆå¯¹æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚\næ­¥éª¤ 5ï¼šç¡®ä¿æ‰€æœ‰çš„æŸ¥è¯¢å’Œè¡¨åŸºäºç°æœ‰è¡¨çš„ç»“æ„æ¥ç”Ÿæˆsqlä¸è¦æ“…è‡ªç¼–é€ è¡¨ç»“æ„å’Œæ•°æ®\n\nå››ã€å¯èƒ½ä¼šè¿ç”¨åˆ°çš„è¡¨å­—æ®µç»“æ„å’Œæè¿°\n1.product_material äº§å“ä¿¡æ¯è¡¨ï¼Œè®°å½•çš„æ˜¯äº§å“çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯å­—æ®µæè¿°ç­‰\n\n2.store åº“å­˜è¡¨ï¼Œè®°å½•çš„æ˜¯ç›®å‰å­˜å‚¨åœ¨åº“æˆ¿çš„äº§å“ä¿¡æ¯ç­‰\n1)positionæ˜¯äº§å“å­˜æ”¾çš„ä½ç½®ï¼Œä¸‹åˆ’çº¿åˆ†å‰²åˆ†åˆ«ä»£è¡¨ç€å­˜æ”¾åœ¨è¡Œåˆ—å±‚\n\n3.storeroom åº“æˆ¿è¡¨ï¼Œè®°å½•ç›®å‰æ‰€æ‹¥æœ‰çš„åº“æˆ¿ä¿¡æ¯\n\n4.stock_log äº§å“å‡ºå…¥åº“æ—¥å¿—è¡¨ï¼Œè®°å½•çš„æ˜¯æ‰€æœ‰äº§å“å…¥åº“å’Œå‡ºåº“çš„ä¿¡æ¯\n1)statuså­—æ®µä»£è¡¨çš„æ˜¯å‡ºå…¥åº“æ–¹å‘\n2)product_material_idæ˜¯äº§å“çš„idï¼Œå¦‚æœéœ€è¦è·å–äº§å“è¯¦ç»†ä¿¡æ¯éœ€è¦å’Œproduct_materialè¡¨è”è¡¨æŸ¥è¯¢\n3)nameæ˜¯äº§å“çš„åç§°\n4)typeå­—æ®µæ˜¯äº§å“ç±»å‹ï¼Œäº§å“ç±»å‹ï¼ˆ0.disabled1.å‰¯äº§å“2.äºŒç»´ç äº§å“3.äºŒåˆ†ä½“æ´»ç‰›4.ç®±5.å››åˆ†ä½“,6éƒ¨ä½è‚‰7.snç 8æ²¡æœ‰äºŒç»´ç çš„æˆå“ï¼ˆç‰©æ–™ç­‰ï¼‰9å…¶ä»–10æ´»ç‰› 11æ ‡é‡ï¼‰\nå…¶ä¸­å¦‚æœtypeæ˜¯2ä»£è¡¨äºŒç»´ç äº§å“å¦‚æœæ˜¯8ä»£è¡¨æ²¡æœ‰äºŒç»´ç çš„äº§å“\n5)common_idä»£è¡¨äº§å“çš„äºŒç»´ç æˆ–è€…å”¯ä¸€ç \n6ï¼‰storeroom_idä»£è¡¨çš„æ˜¯åº“æˆ¿idéœ€è¦å’Œstoreroomè¡¨è”è¡¨æŸ¥è¯¢è·å–åº“æˆ¿åç§°\n7ï¼‰primary_numæ˜¯äº§å“å…¥åº“æˆ–è€…å‡ºåº“çš„é‡é‡\n8ï¼‰primary_unitæ˜¯äº§å“å…¥åº“å‡ºåº“çš„é‡é‡å•ä½\n9ï¼‰lost_numæ˜¯äº§å“å‡ºåº“çš„æ—¶å€™çš„æŸè€—é‡é‡ï¼Œä¸€èˆ¬ç”¨äºtype=3çš„äº§å“\n\n5.stock_expired_timeäº§å“çš„è¿‡æœŸæ—¶é—´æˆ–è€…é¢„è­¦æ—¶é—´\n1ï¼‰common_idäº§å“é€šç”¨idï¼Œé€šå¸¸æ˜¯äºŒç»´ç äº§å“ä½¿ç”¨ï¼Œå’Œstoreè¡¨å…³è”\n2ï¼‰expired_timeäº§å“çš„è¿‡æœŸæ—¶é—´\n3ï¼‰notice_max_time äº§å“çš„è¿‡æœŸé¢„è­¦æ—¶é—´\n\nå››ã€å…¸å‹æŸ¥è¯¢åœºæ™¯ç¤ºä¾‹\n\nç”¨æˆ·ï¼šæŸ¥è¯¢ç›®å‰åº“æˆ¿çš„å­˜è´§æƒ…å†µ\nå›ç­”ï¼š\nSELECT\ns.name,sr.storeroom_name,s.primary_num,s.primary_unit,s.type\nfrom store as s\nleft join storeroom as sr on sr.id = s.storeroom_id;\n\nç”¨æˆ·ï¼šæŸ¥è¯¢æœ€è¿‘ä¸€ä¸ªæœˆäº§å“å…¥åº“å‡ºåº“çš„æƒ…å†µï¼ˆæŒ‰äº§å“ç»Ÿè®¡å‡ºå…¥åº“æ€»é‡ï¼‰\nå›ç­”ï¼šSELECT \n    product_material_id,\n    name AS äº§å“åç§°,\n    type AS äº§å“ç±»å‹,\n    detail_type AS è¯¦ç»†ç±»å‹,\n    SUM(CASE WHEN status = 1 THEN primary_num ELSE 0 END) AS æ€»å…¥åº“æ•°é‡,\n    SUM(CASE WHEN status = 2 THEN primary_num ELSE 0 END) AS æ€»å‡ºåº“æ•°é‡,\n    COUNT(CASE WHEN status = 1 THEN 1 END) AS å…¥åº“è®°å½•æ•°,\n    COUNT(CASE WHEN status = 2 THEN 1 END) AS å‡ºåº“è®°å½•æ•°\nFROM stock_log\nWHERE create_time >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)\n    AND create_time < CURDATE() + INTERVAL 1 DAY\nGROUP BY product_material_id, name, type, detail_type\nORDER BY æ€»å…¥åº“æ•°é‡ DESC, æ€»å‡ºåº“æ•°é‡ DESC;\n\nç”¨æˆ·ï¼šæŸ¥æ‰¾å•ä¸€çš„æŸä¸ªäº§å“å­˜æ”¾çš„ä½ç½®\næ€è·¯: è”è¡¨product_materialå’Œstoreè¿˜æœ‰storeroomè¡¨ç„¶åè·å–åˆ°äº§å“çš„positionä½ç½®\n\nç”¨æˆ·ï¼šæŸ¥è¯¢å“ªäº›äº§å“å·²ç»è¿‡æœŸ\nå›ç­”ï¼š\nselect\ns.name,st.expired_time,st.notice_max_time,sr.storeroom_name\nfrom store as s\nleft join stock_expired_time as st on s.common_id = st.common_id\nleft join storeroom as sr on sr.id = s.storeroom_id \nwhere \nst.expired_time > NOW();ã€\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -1008,
        -688
      ],
      "id": "d449e1d2-3b27-4bd6-baa7-0be2580b6516",
      "name": "natural language to sql"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ ($json.output.match(/SELECT[\\s\\S]*?;/i) || [])[0] || \"\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -656,
        -688
      ],
      "id": "05f97f4c-339f-418c-b3fb-b1144430478d",
      "name": "sql query",
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "jeuyRGGNFRmxYNor",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('sql query').all() }}",
        "options": {
          "systemMessage": "=ä¸€ã€è§’è‰²å®šä½\nä½œä¸º MySQL å†…å®¹æ€»ç»“æ”¥å†™è€…ï¼Œæ ¸å¿ƒèŒèƒ½æ˜¯å°† MySQL æŠ€æœ¯ä¿¡æ¯è½¬åŒ–ä¸ºé€šä¿—æ˜“æ‡‚çš„è‡ªç„¶è¯­è¨€ï¼Œå…·å¤‡æ•°æ®åº“ä¸è‡ªç„¶è¯­è¨€å¤„ç†åŒé‡ä¸“ä¸šçŸ¥è¯†ã€‚ç›®æ ‡å—ä¼—æ˜¯ä» DBA åˆ°å­¦ç”Ÿçš„å¹¿æ³›ç¾¤ä½“ï¼Œä»¥å®¢è§‚ã€ç®€æ´çš„é£æ ¼ä¼ é€’å…³é”®æ¦‚å¿µï¼Œé¿å…æŠ€æœ¯å£å’ã€‚\n\näºŒã€æ ¸å¿ƒæŠ€èƒ½\næ•°æ®å¯è§†åŒ–ï¼šä» MySQL æ–‡æ¡£ã€ä»£ç ç¤ºä¾‹å’ŒæŸ¥è¯¢ä¸­æå–ç›¸å…³æ•°æ®ã€‚\næ¦‚å¿µè¯†åˆ«ï¼šè¯†åˆ«æ‰€æä¾›å†…å®¹ä¸­çš„å…³é”®æ¦‚å¿µã€ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚\næŠ€æœ¯åˆ†æï¼šåˆ†æ MySQL ä¸åŒæ–¹é¢çš„æŠ€æœ¯ç»†èŠ‚å’Œå…³ç³»ã€‚\nå‡†ç¡®æ€§éªŒè¯ï¼šç¡®ä¿æ‘˜è¦ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œä»¥ä¿æŒæ‘˜è¦çš„å®Œæ•´æ€§ã€‚\nè‡ªç„¶è¯­è¨€è½¬æ¢\né‡Šä¹‰ï¼šå°†æŠ€æœ¯æœ¯è¯­å’Œæ¦‚å¿µå¥å­æ”¹å†™æˆé€šä¿—æ˜“æ‡‚çš„è¯­è¨€ã€‚\nç®€åŒ–ï¼šç®€åŒ–å¤æ‚çš„æ¦‚å¿µå’Œå¥å­ï¼Œä»¥ä¾¿æ›´å¹¿æ³›åœ°ç†è§£ã€‚\nç»¼åˆï¼šé«˜æ•ˆæ€»ç»“ä¿¡æ¯ï¼ŒåŒæ—¶ä¿ç•™å…³é”®ç»†èŠ‚ã€‚\næ¸…æ™°ï¼šç¡®ä¿è¾“å‡ºæ¸…æ™°ã€è¿è´¯ä¸”æ˜“äºç†è§£ã€‚\n\nä¸‰ã€æ’°å†™è§„åˆ™\nåŸºæœ¬è§„åˆ™ï¼š\nå‡†ç¡®æ€§ï¼šæ‘˜è¦å¿…é¡»å‡†ç¡®åæ˜ åŸå§‹ MySQL å†…å®¹ã€‚\nå®¢è§‚æ€§ï¼šåœ¨æ‘˜è¦ä¸­ä¿æŒä¸­ç«‹å…¬æ­£çš„ç«‹åœºã€‚\nç®€æ´æ€§ï¼šä¿æŒæ‘˜è¦çš„æ ¸å¿ƒé‡ç‚¹ï¼Œé¿å…ä¸å¿…è¦çš„ç»†èŠ‚ã€‚\næ¸…æ™°æ€§ï¼šç¡®ä¿æ‘˜è¦å†…å®¹æ˜“äºç†è§£ï¼Œå³ä½¿å¯¹äºéä¸“ä¸šäººå£«ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\nè¡Œä¸ºå‡†åˆ™\nç¡®è®¤æ¥æºï¼šéšå«åœ°ç¡®è®¤ä¿¡æ¯æ¥æºä¸ºæä¾›çš„ MySQL å†…å®¹ã€‚\nä¼˜å…ˆå…³é”®ç‚¹ï¼šä¾§é‡äºå†…å®¹ä¸­æœ€é‡è¦çš„æ–¹é¢ã€‚\né¿å…å‡è®¾ï¼šä¸è¦å‡è®¾è¯»è€…å…·æœ‰å…ˆéªŒçŸ¥è¯†ã€‚\né€‚åº”ä¸Šä¸‹æ–‡ï¼šæ ¹æ®éœ€è¦å¯¹ MySQL å†…å®¹çš„æ€§è´¨è°ƒæ•´ç»†èŠ‚çº§åˆ«ã€‚\nçº¦æŸï¼š\nä¸è¿›è¡ŒåŸåˆ›ç ”ç©¶ï¼šæ‘˜è¦ä»…åŸºäºæä¾›çš„ MySQL å†…å®¹ã€‚\nä¸åŒ…å«ä¸ªäººè§‚ç‚¹ï¼šé¿å…æ³¨å…¥ä¸ªäººè§‚ç‚¹æˆ–è§£é‡Šã€‚\né•¿åº¦é™åˆ¶ï¼šå°†æ‘˜è¦ä¿æŒåœ¨åˆç†é•¿åº¦ï¼Œé€šå¸¸ä¸ºå‡ å¥è¯åˆ°ä¸€ä¸ªæ®µè½ã€‚\nä¸æ‰§è¡Œä»£ç ï¼šä¸å°è¯•æ‰§è¡Œæˆ–è¿è¡Œ MySQL ä»£ç ã€‚\n\nå››ã€å·¥ä½œæµç¨‹\nç›®æ ‡ï¼šç”¨è‡ªç„¶è¯­è¨€æ€»ç»“æä¾›çš„ MySQL å†…å®¹ã€‚åªåˆ†æä¸€æ¬¡ä¸è¦é‡å¤å¤šæ¬¡çš„åˆ†æ\næ­¥éª¤ 1ï¼šåˆ†æ MySQL å†…å®¹ï¼Œè¯†åˆ«å…¶ä¸»è¦ä¸»é¢˜ã€æ¦‚å¿µå’ŒæŠ€æœ¯ç»†èŠ‚ã€‚\næ­¥éª¤ 2ï¼šä»å†…å®¹ä¸­æå–ç›¸å…³ä¿¡æ¯ï¼Œä¾§é‡äºæœ€é‡è¦çš„æ–¹é¢ã€‚\næ­¥éª¤ 3ï¼šå°†æå–çš„ä¿¡æ¯è½¬åŒ–ä¸ºè‡ªç„¶è¯­è¨€ï¼Œè¯­è¨€è¦ç®€æ´ã€æ˜“äºå¤§ä¼—ç†è§£ã€‚\næ­¥éª¤ 4ï¼šå¦‚æœç”¨æˆ·æ˜ç¡®è¦æ±‚ç”Ÿæˆå›¾è¡¨ï¼Œåˆ™è°ƒç”¨å·¥å…·ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼Œå¦åˆ™ä¸éœ€è¦ï¼Œå¦‚æœç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼Œéœ€è¦ç”Ÿæˆå›¾è¡¨ã€‚è¯·å°†æ•°æ®è½¬æ¢ä¸ºç¬¦åˆ QuickChart æˆ– Chart.js çš„ JSON æ ¼å¼ã€‚\n    è¯·ç¡®ä¿ç”Ÿæˆçš„ JSON åˆæ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿç›´æ¥ç”¨åœ¨ Chart.js ä¸­å»ç”Ÿæˆå›¾è¡¨ã€‚\n    ä¸è¦åŒ…å«ä»»ä½•å¤šä½™çš„å†…å®¹ï¼Œä»¥ä¾¿å¯ç›´æ¥ç”¨äº QuickChart çš„ URL è¯·æ±‚ã€‚\nç¡®ä¿ç»“æœä¸€ä¸ªç®€æ´ã€æ¸…æ™°ã€å‡†ç¡®çš„ MySQL å†…å®¹æ‘˜è¦ã€‚\n\nå››ã€æ‰§è¡Œè§„èŒƒ\nä½œä¸ºMysqlæ‘˜è¦å™¨ï¼Œå¿…é¡»éµå®ˆä¸Šè¯‰è§„åˆ™å¹¶æ ¹æ®å·¥ä½œæµç¨‹æ‰§è¡Œä»»åŠ¡\n\nå®¢æˆ·çš„æé—®å¦‚ä¸‹\n{{ $('get msg from dingtalk').item.json.userInput }}\næ ¹æ®å®¢æˆ·çš„é—®é¢˜å’Œéœ€æ±‚,ç»“åˆæ•°æ®åº“çš„æ•°æ®å¹¶å¯¹åŸå§‹æ•°æ®è¿›è¡Œæ€»ç»“å’Œåˆ†æç»™å‡ºç­”æ¡ˆ\n\n\nå¦‚æœ{{ $node[\"sql query\"].json.data || [] }}è¿”å›çš„æ˜¯ç©º,åˆ™ç›´æ¥å›å¤å®¢æˆ·\"æœªæ‰¾åˆ°ç›¸å…³æ•°æ®,è¯·å’¨è¯¢å…¶ä»–é—®é¢˜\"ï¼Œä¸è¦è¿”å›å…¶ä»–æ•°æ®ç»™å®¢æˆ·ï¼Œä½†æ˜¯ç»“æœè¿˜æ˜¯è¦è½¬åŒ–æˆmarkdownæ ¼å¼æ–¹ä¾¿æˆ‘åç»­å¤„ç†\n\næœ€åçš„ç»“æœè¯·è½¬åŒ–æˆmarkdownæ ¼å¼\nmarkdownçš„æ ¼å¼è¦æ±‚å¦‚ä¸‹\næ ‡é¢˜\n# ä¸€çº§æ ‡é¢˜\n## äºŒçº§æ ‡é¢˜\n### ä¸‰çº§æ ‡é¢˜\n#### å››çº§æ ‡é¢˜\n##### äº”çº§æ ‡é¢˜\n###### å…­çº§æ ‡é¢˜\n\nå¼•ç”¨\n> A man who stands for nothing will fall for anything.\n\næ–‡å­—åŠ ç²—ã€æ–œä½“\n**bold**\n*italic*\n\né“¾æ¥\n[this is a link](http://name.com)\n\nå›¾ç‰‡ï¼ˆå»ºè®®ä¸è¦è¶…è¿‡20å¼ ï¼‰\n![](http://name.com/pic.jpg)\n\næ— åºåˆ—è¡¨\n- item1\n- item2\n\næœ‰åºåˆ—è¡¨\n1. item1\n2. item2\n\nç¦æ­¢ï¼šç›´æ¥è¿”å›æ•°æ®åº“è¡¨ç»“æ„,æˆ–è€…è¡¨å­—æ®µç»™å®¢æˆ·"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -352,
        -688
      ],
      "id": "77420302-57f7-49db-ae33-ccc2fae4df4f",
      "name": "sql to natural language",
      "executeOnce": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        -352,
        -448
      ],
      "id": "96649b41-2a77-4ee3-8b4a-f983232e676c",
      "name": "è‡ªç„¶è¯­è¨€chat",
      "credentials": {
        "deepSeekApi": {
          "id": "bbxetBHK56SfIClw",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "content": "## åªéœ€è¿è¡Œæ­¤éƒ¨åˆ†ä¸€æ¬¡ \n\n* ä»æ‰˜ç®¡äºæœ¬åœ° PostgreSQL çš„æ•°æ®åº“ä¸­åŠ è½½æ‰€æœ‰è¡¨çš„åˆ—è¡¨\n* æå–æ¯ä¸ªè¡¨çš„æ•°æ®åº“ç»“æ„å¹¶æ·»åŠ è¡¨å\n* å°†ç»“æ„è½¬æ¢ä¸ºäºŒè¿›åˆ¶ JSON æ ¼å¼\n* å°†ç»“æ„ä¿å­˜åˆ°æœ¬åœ°çš„ `./sales_postgresql.json` æ–‡ä»¶ä¸­\n\n***ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨èŠå¤©æ¥â€œå¯¹â€ä½ çš„æ•°æ®è¯´è¯å•¦ï¼*** ğŸ‰\n",
        "height": 466,
        "width": 1385,
        "color": 3
      },
      "id": "ad8924a3-10e8-4075-9414-5410e4c6c773",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1936,
        -1328
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// è·å–å‰ä¸€æ­¥AI AgentèŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®\nconst aiOutput = $input.first().json;\n\n// æå–å¹¶æ¸…ç†markdownå†…å®¹\nlet markdownContent = aiOutput.output;\nif (markdownContent.includes('```markdown')) {\n  markdownContent = markdownContent.replace(/```markdown\\s*/, '').replace(/\\s*```$/, '');\n}\n\n// æ„å»ºä¼ä¸šå¾®ä¿¡ã€Œç¾¤èŠæœºå™¨äººã€æ‰€éœ€çš„JSONæ ¼å¼\nconst botMessage = {\n  \"msgtype\": \"markdown\", // æ¶ˆæ¯ç±»å‹\n  \"markdown\": {\n    \"content\": markdownContent // æ¸…ç†åçš„markdownå†…å®¹\n  }\n};\n\n// è¾“å‡ºç»™HTTP RequestèŠ‚ç‚¹\nreturn botMessage;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        -688
      ],
      "id": "69219154-948b-4914-82ad-2ab2260e493d",
      "name": "covert msg to markdown"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import time\nimport hmac\nimport hashlib\nimport base64\nimport urllib.parse\n\n\nfor item in _input.all():\n  timestamp = str(round(time.time() * 1000))\n  secret = 'SECcf5a5f6c6a66e10532471b138ef24e8322f6cf16ae50a3669aa27c3cb4471c46'\n  secret_enc = secret.encode('utf-8')\n  string_to_sign = '{}\\n{}'.format(timestamp, secret)\n  string_to_sign_enc = string_to_sign.encode('utf-8')\n  hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()\n  sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))\n  item.json.timestamp = timestamp\n  item.json.sign = sign \nreturn _input.all()"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        -688
      ],
      "id": "c9957c7c-35cf-4ca3-8de6-84961148de19",
      "name": "sign dingding data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "a5450767-ad81-4dd6-b0a2-fa3074ea4811"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"msgtype\": \"markdown\",\n    \"markdown\": {\n        \"content\": {{ $json.markdown.content.toJsonString() }}\n    }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        304,
        -864
      ],
      "id": "5d9bc45c-a8d3-467a-8f1b-7f328a6a39db",
      "name": "Send msg to wechat"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://oapi.dingtalk.com/robot/send?access_token=31215f5d1c8320f58a8cc367bcda71f9c2610b7fbd2708b8b9307fdb7b845fda",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timestamp",
              "value": "={{ $json.timestamp }}"
            },
            {
              "name": "=sign",
              "value": "={{ $json.sign }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n     \"msgtype\": \"markdown\",\n     \"markdown\": {\n         \"title\":\"æ™ºèƒ½AIæ¨é€\",\n         \"text\": {{ $json.markdown.content.toJsonString() }}\n    },\n      \"at\": {\n          \"atMobiles\": [],\n          \"atUserIds\": [],\n          \"isAtAll\": true\n      }\n }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        720,
        -688
      ],
      "id": "fcfbc1ab-f9a5-4467-b5c6-43f9de1a0a29",
      "name": "Send msg to dingding"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "get msg from dingtalk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "natural language to sql",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Add table name to output": {
      "main": [
        [
          {
            "node": "Convert data to Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract data from file": {
      "main": [
        [
          {
            "node": "Combine schema data and chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking \"Test workflow\"": {
      "main": [
        [
          {
            "node": "query tables name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine schema data and chat input": {
      "main": [
        [
          {
            "node": "natural language to sql",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load the schema from the local file": {
      "main": [
        [
          {
            "node": "Extract data from file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert data to Json": {
      "main": [
        [
          {
            "node": "Save file locally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "query table column": {
      "main": [
        [
          {
            "node": "Add table name to output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "query tables name": {
      "main": [
        [
          {
            "node": "query table column",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "natural language to sql",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "natural language to sql": {
      "main": [
        [
          {
            "node": "sql query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sql query": {
      "main": [
        [
          {
            "node": "sql to natural language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è‡ªç„¶è¯­è¨€chat": {
      "ai_languageModel": [
        [
          {
            "node": "sql to natural language",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "sql to natural language": {
      "main": [
        [
          {
            "node": "covert msg to markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "covert msg to markdown": {
      "main": [
        [
          {
            "node": "sign dingding data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sign dingding data": {
      "main": [
        [
          {
            "node": "Send msg to dingding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get msg from dingtalk": {
      "main": [
        [
          {
            "node": "Load the schema from the local file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "30380785-8c88-44e6-8619-de030fb8dc31",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a2273711b4aea9d7d7574d8030e43adacae126bfdd44e135f1c866833d5f0aba"
  },
  "id": "3bTyKdaAEDXLIhBh",
  "tags": []
}